<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Griglia di Autovalutazione</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f3f4f6; }
        .card { background-color: #fff; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); margin: 0 auto; max-width: 4xl; padding: 24px; }
        .card-header { padding-bottom: 1rem; }
        .card-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        .card-description { color: #6b7280; font-size: 1rem; }
        .card-content { margin-top: 1.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .label { display: block; font-size: 0.875rem; font-weight: bold; margin-bottom: 0.25rem; }
        .input { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); font-size: 1rem; }
        .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .alert { padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem; }
        .alert-destructive { background-color: #fef2f2; border-color: #fecaca; color: #b91c1c; border-width: 1px; }
        .alert-title { font-weight: bold; }
        .alert-description { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }
        .block { display: block; }
        .text-sm { font-size: 0.875rem; }
        .text-gray-500 { color: #6b7280; }
        .mt-1 { margin-top: 0.25rem; }
        .flex { display: flex; }
        .space-x-1 > * + * { margin-left: 0.25rem; }
        .button { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; text-align: center; white-space: nowrap; user-select: none; background-color: #fff; color: #374151; border: 1px solid #d1d5db; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); font-size: 0.875rem; line-height: 1.25rem; }
        .button:hover { background-color: #f9fafb; }
        .button:focus { outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .button-default { background-color: #6366f1; color: #fff; }
        .button-default:hover { background-color: #5a5fcf; }
        .button-default:focus { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); }
        .button-outline { background-color: transparent; border-color: #d1d5db; color: #374151; }
        .button-outline:hover { background-color: #f9fafb; }
        .button-outline:focus { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .w-8 { width: 2rem; }
        .h-8 { height: 2rem; }
        .w-10 { width: 2.5rem; }
        .card-footer { margin-top: 1.5rem; display: flex; justify-content: space-between; gap: 1rem; flex-direction: column; }
        @media (min-width: 768px) {
            .card-footer { flex-direction: row; }
        }
        .w-full { width: 100%; }
        .md-w-auto { width: auto; }
    </style>
</head>
<body>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Griglia di Autovalutazione</h2>
        <p class="card-description">
            Valuta in modo rapido e mirato la tua conformità alle normative chimiche europee REACH, CLP e BPR. Nessun dato verrà salvato, i dati inseriti servono solo a compilare un report stampabile. Questa autovalutazione è utile per tutte le organizzazioni, dai produttori di prodotti chimici alle aziende manifatturiere e di servizi. La chimica, spesso invisibile, deve essere compresa per proteggere la salute e l'ambiente.
        </p>
    </div>
    <div class="card-content space-y-4" id="card-content-area">
        <div id="error-message-area" style="display:none;" class="alert alert-destructive">
            <h3 class="alert-title">Errore</h3>
            <div class="alert-description" id="error-description"></div>
        </div>
        <div class="space-y-2">
            <label for="organization-name" class="label">Nome dell'Organizzazione</label>
            <input type="text" id="organization-name" class="input w-full" placeholder="Nome Organizzazione">
        </div>
        <div class="space-y-2">
            <label for="evaluator-name" class="label">Nome del Valutatore</label>
            <input type="text" id="evaluator-name" class="input w-full" placeholder="Nome Valutatore">
        </div>
        <div class="space-y-2">
            <label for="evaluator-email" class="label">Email del Valutatore</label>
            <input type="email" id="evaluator-email" class="input w-full" placeholder="Email Valutatore">
        </div>
        <div class="space-y-2">
            <label class="block text-sm text-gray-500">
                Nota: Questa autovalutazione non garantisce la piena conformità normativa, ma propone domande fondamentali che ogni Organizzazione dovrebbe porsi nell'interazione con sostanze chimiche, siano esse note, ignote, visibili o meno. Un primo passo per garantire ai clienti e ai consumatori prodotti sempre più sicuri. A cura di chimicodematte.net
            </label>
        </div>
        <div class="space-y-2" id="questions-container">
            </div>
        </div>
    <div class="card-footer flex justify-between">
        <button id="calculate-button" class="button w-full md-w-auto button-default">Calcola Punteggio</button>
        <button id="report-button" style="display:none;" class="button w-full md-w-auto button-default">Punteggio calcolato, clicca per il report</button>
    </div>
</div>

<script>
    const questions = [
        "Quesito 1: Fatti cento i prodotti chimici pericolosi che entrano nella tua organizzazione, quanti hanno una scheda dati di sicurezza aggiornata e verificata, in archivio condiviso?",
        "Quesito 2: I prodotti chimici pericolosi, presenti in azienda, sono etichettati esattamente come scritto nella SDS rispettiva? Quale è il rischio che non siano uguali?",
        "Quesito 3: Qual è il livello di formazione dei tuoi dipendenti sulla lettura e comprensione delle schede dati di sicurezza (SDS) e delle etichette chimiche?",
        "Quesito 4: Quanti prodotti chimici pericolosi utilizzati nell'organizzazione sono stati verificati per la loro classificazione CLP; qualora classificati, gestiti secondo CLP con UFI e notifica al Poison CENTER (per la vendita), o valutati per il rischio (solo per l'utilizzo)?",
        "Quesito 5: L'azienda dispone di un sistema documentato per la gestione delle restrizioni, autorizzazioni di sostanze pericolose e per la mitigazione del rischio che sostanze SVHC o soggette a restrizioni siano presenti negli articoli per scongiurare rischi aziendali anche penali?",
        "Quesito 6: Quante SDS ricevute nell’ultimo anno sono state rigettate o inviate osservazioni ai fornitori, ai sensi dell’articolo 34 del REACH in quanto non corretta o aggiornata, redatta secondo l'Allegato II del REACH? L'ultimo indagine ECHA rileva che il 35% delle SDS sono non-conformi.",
        "Quesito 7: Qual è il grado di controllo e conformità dell'azienda rispetto agli obblighi previsti per i biocidi (ad esempio, autorizzazione dei prodotti biocidi immessi sul mercato anche come preservanti o anti\"qualcosa\")?",
        "Quesito 8: I controlli su articoli e prodotti chimici acquistati e sui processi produttivi in essere quanto tutelano l'organizzazione e il consumatore da una violazione di conformità al regolamento REACH e la sicurezza del prodotto da sostanze chimiche pericolose? Se non hai mai sentito parlare di SCIP scegli zero!",
        "Quesito 9: Quante sostanze chimiche semplici o contenute in miscela non sono state registrate ai fini REACH (numero di registrazione in sezione 3.2 SDS)?",
        "Quesito 10: Quanti processi aziendali includono procedure formali per la verifica proattiva e il mantenimento della conformità normativa (audit interni, gestione del rischio chimico, verifica periodica delle SDS e delle etichette)?",
    ];

    const notes = [
        "Inserisci un valore da 0 a 10. Se tutti i prodotti hanno una scheda dati di sicurezza aggiornata e verificata, inserisci 10. Se nessuno ha una scheda dati di sicurezza aggiornata e verificata, inserisci 0.",
        "Inserisci un valore da 0 a 10. Se tutti i prodotti sono etichettati esattamente come scritto nella SDS, inserisci 10. Se nessuno è etichettato correttamente, inserisci 0.",
        "Inserisci un valore da 0 a 10. Zero nessuna formazione, 10 tutti i settori formati.",
        "Inserisci un valore da 0 a 10. Nessuna valutazione (zero) - piena copertura del rischio chimico (10).",
        "Inserisci un valore da 0 a 10. Zero se qualche rischio esiste, o ci sono già dei precedenti - Dieci se tutto è coperto dal sistema.",
        "Inserisci un valore da 0 a 100. Zero se tutte le SDS sono prese per buone e corrette, 100 se tutte sono state rigettate.",
        "Inserisci un valore da 0 a 10. Zero (non ne sappiamo nulla), dieci (tutto già autorizzato).",
        "Inserisci un valore da 0 a 10. Zero per nessuna protezione - dieci per una protezione completa.",
        "Inserisci un valore da 0 a 10. Zero (non ne ho la minima idea), dieci (tutte le sostanze sono registrate).",
        "Inserisci un valore da 0 a 10. Zero nessun sistema, 10 sistema scritto documentato, verificato e efficiente.",
    ];

    const weights = [15, 5, 10, 5, 15, 10, 10, 20, 5, 5];
    let scores = Array(10).fill(-1);
    let totalScore = 0;
    let classification = '';
    let judgment = '';
    let compilationDateTime = '';
    let organizationName = '';
    let evaluatorName = '';
    let evaluatorEmail = '';
    let errorMessage = '';
    let showDownloadButton = false;

    const cardContentArea = document.getElementById('card-content-area');
    const errorMessageArea = document.getElementById('error-message-area');
    const errorDescription = document.getElementById('error-description');
    const calculateButton = document.getElementById('calculate-button');
    const reportButton = document.getElementById('report-button');
    const questionsContainer = document.getElementById('questions-container');

    function calculateScore() {
        organizationName = document.getElementById('organization-name').value;
        evaluatorName = document.getElementById('evaluator-name').value;
        evaluatorEmail = document.getElementById('evaluator-email').value;

        if (!organizationName || !evaluatorName || !evaluatorEmail) {
            setErrorMessage('Inserisci tutti i dati richiesti.');
            return;
        }

        if (scores.includes(-1)) {
            setErrorMessage('Rispondi a tutti i quesiti.');
            return;
        }

        let rawScore = 0;
        let totalWeight = 0;

        for (let i = 0; i < 10; i++) {
            let value = scores[i];
            if (i === 5) {
                const percentage = scores[i];
                if (percentage > 35) {
                    value = 10;
                } else {
                    value = (percentage / 35) * 10;
                }
            }
            rawScore += value * weights[i];
            totalWeight += weights[i];
        }

        const maxPossibleScore = weights.reduce((acc, weight) => acc + weight * 10, 0);
        const normalizedScore = (rawScore / maxPossibleScore) * 100;
        totalScore = normalizedScore;
        classifyScoreFunc(normalizedScore);
        judgeScoreFunc(normalizedScore);
        showDownloadButton = true;
        setErrorMessage('');
        compilationDateTime = new Date().toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        updateUI();
    }

    function classifyScoreFunc(score) {
        if (score >= 80) {
            classification = 'Eccellente';
        } else if (score >= 60) {
            classification = 'Buono';
        } else if (score >= 40) {
            classification = 'Moderato';
        } else {
            classification = 'Scarso';
        }
    }

    function judgeScoreFunc(score) {
        if (score >= 95) {
            judgment = 'Conformità eccellente. L\'azienda è allineata ai requisiti normativi.';
        } else if (score >= 85) {
            judgment = 'Conformità buona. Esistono alcune aree di miglioramento.';
        } else if (score >= 65) {
            judgment = 'Conformità appena sufficiente. È necessaria una revisione più approfondita.';
        } else {
            judgment = 'Conformità insufficiente. L\'azienda deve implementare interventi urgenti per allinearsi ai requisiti normativi.';
        }
    }

    function handleScoreChange(index, value) {
        scores[index] = value;
        renderScale(index); // Re-render to update button styles
    }

    function renderScale(index) {
        const scaleContainer = document.getElementById(`scale-container-${index}`);
        scaleContainer.innerHTML = ''; // Clear existing buttons

        let buttonsHTML = '';
        let scaleLength = 11;
        let valueMultiplier = 1;
        let percentageSymbol = '';

        if (index === 5) {
            valueMultiplier = 10;
            percentageSymbol = '%';
        }

        for (let i = 0; i < scaleLength; i++) {
            const buttonValue = i * valueMultiplier;
            const isSelected = scores[index] === buttonValue;
            const variantClass = isSelected ? 'button button-default' : 'button button-outline';

            buttonsHTML += `
                <button
                    class="${variantClass} w-${index === 5 ? '10' : '8'} h-8"
                    onclick="handleScoreChange(${index}, ${buttonValue}); renderScale(${index})"
                    ontouchend="handleScoreChange(${index}, ${buttonValue}); renderScale(${index})"
                    aria-label="Punteggio ${buttonValue}${percentageSymbol} per la domanda ${index + 1}"
                >
                    ${buttonValue}${percentageSymbol}
                </button>
            `;
        }
        scaleContainer.innerHTML = `<div class="flex space-x-1">${buttonsHTML}</div>`;
    }


    function setErrorMessage(message) {
        errorMessage = message;
        if (errorMessage) {
            errorDescription.textContent = errorMessage;
            errorMessageArea.style.display = 'block';
        } else {
            errorMessageArea.style.display = 'none';
        }
    }

    function openResultsPage() {
        const progressBarColorClass = getProgressBarColor(totalScore);

        const htmlContent = `
            <!DOCTYPE html>
            <html lang="it">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Report di Autovalutazione</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .page { padding: 30px; }
                    .title { font-size: 24px; margin-bottom: 20px; text-align: center; font-weight: bold; }
                    .note { font-size: 12px; color: #6b7280; margin-bottom: 20px; text-align: center; }
                    .section { margin-bottom: 20px; }
                    .label { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
                    .value { font-size: 14px; margin-bottom: 5px; }
                    .score-bar { display: flex; align-items: center; margin-bottom: 20px; }
                    .score-bar-text { font-size: 14px; margin-left: 10px; }
                    .score-bar-progress { height: 10px; background-color: #e5e7eb; border-radius: 5px; overflow: hidden; flex: 1; margin-right: 10px; }
                    .score-bar-progress-inner { height: 10px; border-radius: 5px; }
                    .red { background-color: #ef4444; }
                    .orange { background-color: #f97316; }
                    .yellow { background-color: #eab308; }
                    .green { background-color: #22c55e; }
                    .final-note { font-size: 16px; color: #1e40af; margin-top: 20px; text-align: center; }
                    .large-score { font-size: 24px; font-weight: bold; color: #1e40af; margin-top: 20px; text-align: center; }
                    .classification { font-size: 24px; font-weight: bold; color: #1e40af; margin-top: 20px; text-align: center; }
                    .judgment { font-size: 24px; font-weight: bold; color: #1e40af; margin-top: 20px; text-align: center; }
                    .image { display: block; margin: 0 auto; max-width: 50%; height: auto; }
                    .info-box { background-color: #f9fafb; border: 1px solid #e2e8f0; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
                    .info-box-item { margin-bottom: 8px; }
                </style>
            </head>
            <body>
                <div class="page">
                    <div class="title">Report di Autovalutazione</div>
                    <img src="https://chimicodematte.wordpress.com/wp-content/uploads/2025/01/screenshot_28-1-2025_152943_www.canva_.com_.jpeg" alt="Logo ChimicoDematte" class="image">
                    <div class="note">
                        Nota: Questa autovalutazione non garantisce la piena conformità normativa, ma propone domande fondamentali che ogni Organizzazione dovrebbe porsi nell'interazione con sostanze chimiche, siano esse note, ignote, visibili o meno. Un primo passo per garantire ai clienti e ai consumatori prodotti sempre più sicuri. A cura di chimicodematte.net
                    </div>
                    <div class="info-box">
                        <div class="info-box-item"><strong>Data e Ora della Compilazione:</strong> ${compilationDateTime}</div>
                        <div class="info-box-item"><strong>Organizzazione:</strong> ${organizationName}</div>
                        <div class="info-box-item"><strong>Valutatore:</strong> ${evaluatorName}</div>
                        <div class="info-box-item"><strong>Email del Valutatore:</strong> ${evaluatorEmail}</div>
                    </div>
                    ${questions.map((question, index) => `
                        <div class="section">
                            <div class="label">${index + 1}. ${question}</div>
                            <div class="value">Risposta: ${scores[index]}</div>
                        </div>
                    `).join('')}
                    <div class="score-section">
                        <div class="score-details">
                            <div class="score-bar">
                                <div class="score-bar-progress">
                                    <div class="score-bar-progress-inner ${progressBarColorClass}" style="width: ${totalScore}%;"></div>
                                </div>
                                <div class="score-bar-text">Punteggio autovalutazione: ${totalScore.toFixed(2)}%</div>
                            </div>
                            <div class="large-score">
                                Punteggio Finale: ${totalScore.toFixed(2)}%
                            </div>
                            <div class="classification">
                                Classificazione: ${classification}
                            </div>
                            <div class="judgment">
                                Giudizio: ${judgment}
                            </div>
                            <div class="final-note">
                                NOTA: Questa autovalutazione non garantisce la piena conformità normativa, propone domande fondamentali che ogni Organizzazione dovrebbe porsi nell'interazione con sostanze chimiche, siano esse note, ignote, visibili o meno. Un primo passo per garantire ai clienti e ai consumatori prodotti sempre più sicuri. Se hai bisogno di consulenza rivolgiti senza indugio a <a href="https://chimicodematte.net/" target="_blank">https://chimicodematte.net/</a>
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
    }

    function getProgressBarColor(score) {
        if (score < 65) {
            return 'red'; // Rosso
        } else if (score < 85) {
            return 'orange'; // Arancione
        } else if (score < 95) {
            return 'yellow'; // Giallo
        } else {
            return 'green'; // Verde
        }
    }

    function updateUI() {
        reportButton.style.display = showDownloadButton ? 'inline-flex' : 'none';

        // Re-render questions and scales
        let questionsHTML = '';
        for (let i = 0; i < questions.length; i++) {
            questionsHTML += `
                <div class="space-y-2">
                    <label for="question-${i + 1}" class="label block">
                        ${questions[i]}
                        <span class="block text-sm text-gray-500 mt-1">${notes[i]}</span>
                    </label>
                    <div id="scale-container-${i}"></div>
                </div>`;
        }
        questionsContainer.innerHTML = questionsHTML; // Render questions inside questions-container

        for (let i = 0; i < questions.length; i++) {
            renderScale(i);
        }
    }


    calculateButton.addEventListener('click', calculateScore);
    calculateButton.addEventListener('touchend', calculateScore);
    reportButton.addEventListener('click', openResultsPage);
    reportButton.addEventListener('touchend', openResultsPage);


    updateUI(); // Initial render of questions and scales
</script>

</body>
</html>